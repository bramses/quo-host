<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/textfit/2.4.0/textFit.min.js" integrity="sha512-vLs5rAqfvmv/IpN7JustROkGAvjK/L+vgVDFe7KpdtLztqF8mZDfleK2MZj/xuOrWjma0pW+lPCMcBbPKJVC7g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <title>Quote Animation</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
        height: 100vh;
      }
      .highlight {
        font-weight: bold;
        background-color: #ffff99;
      }
      /* Controls in top left corner buttons in a row */
      #controls {
        position: absolute;
        top: 0;
        left: 0;
        padding: 20px;
      }

      #container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .box {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    /* outline: 1px solid red;  */
  }
  .box1, .box2 {
    height: 80vh;
    /* outline: 1px solid red;  */
  }
  .box1 {
    font-family: 'EB Garamond', serif;
    font-optical-sizing: auto;
    font-weight: 400;
    font-style: normal;
    width: 66vw;
    padding: 10px;
  }
  .box2 {
    width: 33vw;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .box3, .box4 {
    font-family: 'EB Garamond', serif;
    height: 10vh;
    width: 100%;
    padding-left: 1%;
    padding-right: 1%;
    /* outline: 1px solid red; */
  }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="controls">
        <p>
          Click on the buttons below to animate the quote with different lengths:
        </p>
        <button id="long-btn">animate long quote</button>
        <button id="medium-btn">animate medium quote</button>
        <button id="small-btn">animate short quote</button>
      </div>
        <div id="reasoning-container" class="box3">
          <p id="reasoning"></p>
        </div>
        <div class="box">
          <div id="quote-container" class="box1">
            <p id="quote-text"></p>
            <p id="quote-author"></p>
          </div>
          <div id="cover-container" class="box2">
            <img
              src="https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1453131888i/28596619.jpg"
              alt="Book cover"
              style="max-width: 80%; max-height: 80%"
            />
          </div>
        </div>
        <div id="transcript-container" class="box4">
          <p id="transcript"></p>
        </div>
      </div>
    </div>
    <script>
      const longQuote = {
        text: "It\u2019s a mistake to lose our sense of proportion, even when contemplating one\u2019s own demise\u2014**especially when contemplating one\u2019s own demise.** It\u2019s true that we all must die eventually, but why be so dramatic about it? **Contemplation of death is scary.** I get it. But taken in context, it\u2019s a relatively brief event. In one of his last journal entries, Montaigne noted that as dying amounts to just a few bad moments at the end of life, it\u2019s really not worth worrying about. If it takes an hour to die, that would represent just one 700,000th of an average human lifetime. That\u2019s a pretty good ratio, when all is said and done. And if even one hour in 700,000 is too much for you, there are far quicker ways out\u2014guaranteed painless\u2014should you choose to take control of the process yourself or have a compassionate doctor. And as for what comes next, **what\u2019s to fear from that?** As Mark Twain put it, **\u201cI do not fear death. I had been dead for billions and billions of years before I was born, and had not suffered the slightest inconvenience from it.\u201d** But the NPP keeps warning that it\u2019s a jungle out there, and only the ramparts of civilization can protect us from \u201cbeing devoured from within by rasping parasites\u201d and the rest of nature, red in tooth and claw, waiting to pounce.",
        author: "Christopher Ryan",
        title: "Civilized to Death: The Price of Progress",
        reasoning:
          "The third quote is most relevant and stimulating for conversation when considering the transcription's discussion about the nature of existence and death. It directly addresses the fears associated with contemplating one's own demise, encapsulated in the phrases 'contemplation of death is scary' and 'I do not fear death. I had been dead for billions and billions of years before I was born, and had not suffered the slightest inconvenience from it.'",
        transcript:
          "Deep down, you is the whole universe. So then when you die, you're not going to have to put up with everlasting non existence, because that's not an experience. A lot of people are afraid that when they die, they're going to be locked up in a dark room forever and sort of undergo that.",
        cover:
          "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1453131888i/28596619.jpg",
      };
      const shortQuote = {
        text: "**It takes the whole of life to learn how to live, and \u2014 what will perhaps make you wonder more \u2014 it takes the whole of life to learn how to die.**",
        author: "Lucius Seneca",
        title: "On the Shortness of Life",
        reasoning:
          "The quote from Lucius Seneca, 'It takes the whole of life to learn how to live, and \u2014 what will perhaps make you wonder more \u2014 it takes the whole of life to learn how to die.', connects directly with the transcription's contemplation on the notion of going to sleep and never waking up. Seneca's words encapsulate the lifelong journey of understanding both living and the inevitable cessation of life, aligning with the transcription's exploration of contemplating one's own mortality.",
        transcript:
          "Think about that, children. Think about. It's one of the great wonders of life. What will it be like to go to sleep and never wake up? And if you think long enough about that, something will happen to you.",
        cover:
          "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1619107079i/97412.jpg",
      };
      const mediumQuote = {
        text: "**Two beings inhabit your body:** you, who stumbles groggily to the coffeepot to start another day, **and the writer in you, who could remain blissfully asleep and unaware for days, months, even years as you go on about your business.** If your writer is anything like mine, \u201clazy,\u201d even \u201cslug\u201d is too kind. **Always wake up your writer early,** so you can spend the day together. **It's amazing the fun the two of you can have watching the world go by.** Your writer will be active beside you, sniffing and tasting, snooping for metaphors. **It's like writing all day without moving your fingers.**",
        author: "Pat Pattison",
        title: "Writing Better Lyrics",
        reasoning:
          "The second quote interestingly personifies the writer within as a separate being that needs awakening, resonant with the transcription's imperative tone of waking up and embodying a larger self beyond 'poor little me.' The phrases 'Two beings inhabit your body' and 'Always wake up your writer early' echo the theme of awakening and transformation presented in the transcription.",
        transcript:
          "You're ready to wake up. You're going to wake up. And if you're not ready, you're going to stay, pretending that you're just a little, poor little me.",
        cover:
          "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1387752921i/695626.jpg",
        transcript_times: {
          text: "You're ready to wake up. You're going to wake up. And if you're not ready, you're going to stay, pretending that you're just a little, poor little me.",
          start: 200,
          end: 9074,
          words: [
            {
              text: "You're",
              start: 200,
              end: 440,
              confidence: 0.5516,
            },
            {
              text: "ready",
              start: 440,
              end: 1100,
              confidence: 0.99365,
            },
            {
              text: "to",
              start: 1774,
              end: 2110,
              confidence: 1.0,
            },
            {
              text: "wake",
              start: 2142,
              end: 2374,
              confidence: 0.9997,
            },
            {
              text: "up.",
              start: 2414,
              end: 2590,
              confidence: 0.99922,
            },
            {
              text: "You're",
              start: 2622,
              end: 2806,
              confidence: 0.85142,
            },
            {
              text: "going",
              start: 2830,
              end: 2918,
              confidence: 0.7852,
            },
            {
              text: "to",
              start: 2926,
              end: 3022,
              confidence: 1.0,
            },
            {
              text: "wake",
              start: 3038,
              end: 3230,
              confidence: 0.99982,
            },
            {
              text: "up.",
              start: 3262,
              end: 3766,
              confidence: 0.99951,
            },
            {
              text: "And",
              start: 3910,
              end: 4142,
              confidence: 0.97,
            },
            {
              text: "if",
              start: 4158,
              end: 4262,
              confidence: 0.99953,
            },
            {
              text: "you're",
              start: 4278,
              end: 4454,
              confidence: 0.71062,
            },
            {
              text: "not",
              start: 4494,
              end: 4670,
              confidence: 0.99985,
            },
            {
              text: "ready,",
              start: 4702,
              end: 4958,
              confidence: 0.99909,
            },
            {
              text: "you're",
              start: 5006,
              end: 5206,
              confidence: 0.90256,
            },
            {
              text: "going",
              start: 5230,
              end: 5342,
              confidence: 0.9641,
            },
            {
              text: "to",
              start: 5358,
              end: 5486,
              confidence: 1.0,
            },
            {
              text: "stay,",
              start: 5510,
              end: 5982,
              confidence: 0.99584,
            },
            {
              text: "pretending",
              start: 6118,
              end: 6854,
              confidence: 0.90915,
            },
            {
              text: "that",
              start: 6934,
              end: 7126,
              confidence: 0.98882,
            },
            {
              text: "you're",
              start: 7150,
              end: 7286,
              confidence: 0.75213,
            },
            {
              text: "just",
              start: 7310,
              end: 7494,
              confidence: 0.99864,
            },
            {
              text: "a",
              start: 7534,
              end: 7662,
              confidence: 0.98,
            },
            {
              text: "little,",
              start: 7678,
              end: 7950,
              confidence: 0.95205,
            },
            {
              text: "poor",
              start: 8022,
              end: 8230,
              confidence: 0.78968,
            },
            {
              text: "little",
              start: 8262,
              end: 8454,
              confidence: 0.99939,
            },
            {
              text: "me.",
              start: 8494,
              end: 9074,
              confidence: 0.99917,
            },
          ],
        },
      };
    </script>
    <script>
      // let quoteData = longQuote;
      // animationDelay = getDelayBasedOnStringLength(quoteData.text);
      // run fetch post request every 5 seconds
      // let recentQuoteData = null;

      // setInterval(() => {
      //   fetch("/quote-data", { method: "GET" })
      //     .then((response) => response.json())
      //     .then((newQuoteData) => {
      //       quoteData = newQuoteData;
      //       if (quoteData === null) {
      //         console.log("No new quote data");
      //         return;
      //       }
      //       console.log(quoteData);
      //       if (recentQuoteData && quoteData.text === recentQuoteData.text) {
      //         console.log("Quote data is the same as the previous one");
      //         return;
      //       }

      //       recentQuoteData = quoteData;
      //       animationDelay = getDelayBasedOnStringLength(quoteData.text);

      //       animateQuote();
      //     })
      //     .catch((error) => console.error("Error:", error));
      // }, 5000);
    </script>
    <script>
      function lerp(start, end, t) {
        return start + (end - start) * t;
      }

      function getDelayBasedOnStringLength(str) {
        const minLength = 100;
        const maxLength = 4000;
        const minDelay = 1;
        const maxDelay = 0.01;

        const length = Math.min(Math.max(str.length, minLength), maxLength);
        const t = (length - minLength) / (maxLength - minLength);
        return lerp(minDelay, maxDelay, t);
      }

      let animationDelay = 20;

      function animateText(element, text, delay, callback) {
        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            const span = document.createElement("span");
            span.textContent = text[i];
            element.appendChild(span);
            i++;
          } else {
            clearInterval(interval);
            if (callback) callback();
          }
        }, delay);
      }

      function findHighlights(text) {
        const regex = /\*\*(.*?)\*\*/g;
        const highlights = [];
        let match;

        while ((match = regex.exec(text)) !== null) {
          highlights.push({
            startIdx: match.index,
            offset: match[1].length,
            substr: match[1],
          });
        }

        return highlights;
      }

      function animateHighlights(element, highlights, delay) {
        let totalDelay = 0;
        highlights.forEach((highlight, idx) => {
          setTimeout(() => {
            let i = highlight.startIdx - 4 * idx;
            const interval = setInterval(() => {
              if (i < highlight.startIdx + (highlight.offset - 4 * idx)) {
                if (!element.childNodes[i]) clearInterval(interval);
                element.childNodes[i].classList.add("highlight");
                i++;
              } else {
                clearInterval(interval);
              }
            }, delay);
          }, totalDelay);
          totalDelay += (highlight.offset - 4 * idx) * delay + delay;
        });
      }

      function animateQuote() {
        // clear previous quote
        const quoteContainer = document.getElementById("quote-container");
        const quoteText = document.getElementById("quote-text");
        const reasoning = document.getElementById("reasoning");
        const transcript = document.getElementById("transcript");
        const coverContainer = document.getElementById("cover-container");

        coverContainer.innerHTML = `<img src="${quoteData.cover}" alt="Book cover" style="max-width: 80%; max-height: 80%;" />`;
        quoteText.textContent = "";

        // const quoteAuthor = document.getElementById("quote-author");

        const plaintext = quoteData.text.replace(/\*\*/g, "");
        const highlights = findHighlights(quoteData.text);

        let i = 0;
        while (i < plaintext.length) {
          const span = document.createElement("span");
          span.textContent = plaintext[i];
          quoteText.appendChild(span);
          i++;
        }
        textFit(document.getElementsByClassName('box1'))
        

        animateHighlights(quoteText, highlights, 12);


        // const plaintext = quoteData.text.replace(/\*\*/g, "");
        // const highlights = findHighlights(quoteData.text);

        // animateText(quoteText, plaintext, animationDelay, () => {
        //   animateHighlights(quoteText, highlights, 12);
        // });

        // quoteAuthor.textContent = `- ${quoteData.author}, "${quoteData.title}"`;
        reasoning.textContent = quoteData.reasoning;
        transcript.textContent = quoteData.transcript;

        textFit(document.getElementsByClassName('box3'), {multiLine: true})
        textFit(document.getElementsByClassName('box4'), {multiLine: true})
      }

      function animateTranscript() {
        // bold each word in the transcript from interval start to end
        // set a setTimeout for each word to bold class while a global timer is running
        // clear the bold class after the timer ends
        let globalTimer = 0; // this would be your global timer that increments over time

        function updateText() {
          const updatedText = quoteData.transcript_times.words
            .map((word) => {
              if (globalTimer >= word.start && globalTimer <= word.end) {
                return `<mark>${word.text}</mark>`;
              } else {
                return word.text;
              }
            })
            .join(" ");

          document.getElementById("transcript").innerHTML = updatedText;
        }

        // Assuming you have an element with id 'transcript' in your HTML
        // Update the text every second (or as needed)
        // setInterval(() => {
        //   globalTimer += 10; // Increment time, adjust as necessary
        //   updateText();
        // }, 10);

        // You can also use requestAnimationFrame for smoother updates
        function update() {
          globalTimer += 10; // Increment time, adjust as necessary
          updateText();
          requestAnimationFrame(update);
        }

        requestAnimationFrame(update);

      }

      document.getElementById("long-btn").addEventListener("click", () => {
        quoteData = longQuote;
        animationDelay = getDelayBasedOnStringLength(quoteData.text);
        animateQuote();
      });

      document.getElementById("medium-btn").addEventListener("click", () => {
        quoteData = mediumQuote;
        animationDelay = getDelayBasedOnStringLength(quoteData.text);
        animateQuote();
        animateTranscript();
      });

      document.getElementById("small-btn").addEventListener("click", () => {
        quoteData = shortQuote;
        animationDelay = getDelayBasedOnStringLength(quoteData.text);
        animateQuote();
      });
    </script>
  </body>
</html>
